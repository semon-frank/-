import os
import pandas as pd
import numpy as np
import statsmodels.api as sm
import matplotlib.pyplot as plt
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import r2_score, mean_absolute_error
from sklearn.preprocessing import PolynomialFeatures
from sklearn.linear_model import LinearRegression
from statsmodels.nonparametric.smoothers_lowess import lowess
from tqdm import tqdm
import logging

# =====================================================
# åŸºç¡€è®¾ç½®
# =====================================================
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s",
    handlers=[logging.StreamHandler()]
)

ESS_PATHS = [
    r"C:\Users\25314\Desktop\ESS\ESS4MDWe04.5_F1.sav",
    r"C:\Users\25314\Desktop\ESS\ESS5MDWe03.4_F1.sav",
    r"C:\Users\25314\Desktop\ESS\ESS6MDWe02.4_F1.sav",
    r"C:\Users\25314\Desktop\ESS\ESS7MDWe02.2_F1.sav",
    r"C:\Users\25314\Desktop\ESS\ESS8MDWe02.1_F1.sav",
    r"C:\Users\25314\Desktop\ESS\ESS9MDWe03.1_F1.sav",
    r"C:\Users\25314\Desktop\ESS\ESS10.csv",
    r"C:\Users\25314\Desktop\ESS\ESS11.csv"
]

OUTDIR = r"C:\Users\25314\Desktop\dataPè®¡ç®—ç»“æœ"
os.makedirs(OUTDIR, exist_ok=True)


# =====================================================
# 1. è‡ªåŠ¨æ£€æµ‹å›½å®¶åˆ—
# =====================================================
def detect_country_col(df):
    for c in df.columns:
        cl = c.lower()
        if any(k in cl for k in ["cntry", "country", "nation", "state"]):
            if df[c].nunique() > 5:
                return c
    return None


# =====================================================
# 2. åŠ è½½æ•°æ®ä¸è®¡ç®—P/Så‡å€¼
# =====================================================
def load_ess(path):
    logging.info(f"è¯»å– {path}")
    try:
        if path.endswith(".sav"):
            df = pd.read_spss(path)
        else:
            df = pd.read_csv(path, low_memory=False)
    except Exception as e:
        logging.error(f"âŒ åŠ è½½å¤±è´¥: {e}")
        return None

    ccol = detect_country_col(df)
    if ccol is None:
        df["cntry"] = os.path.basename(path)
    else:
        df = df.rename(columns={ccol: "cntry"})

    # P/S å˜é‡å…³é”®å­—
    P_keys = ["happy", "trust", "satisf", "life", "free", "respect", "fair", "secure", "value", "confid", "self"]
    S_keys = ["gov", "pol", "part", "democ", "edu", "science", "culture", "econ", "relig", "media", "tech"]

    P_cols = [c for c in df.columns if any(k in c.lower() for k in P_keys)]
    S_cols = [c for c in df.columns if any(k in c.lower() for k in S_keys)]

    if len(P_cols) < 5 or len(S_cols) < 5:
        logging.warning(f"âš ï¸ {os.path.basename(path)}: P={len(P_cols)}, S={len(S_cols)}")

    df[P_cols + S_cols] = df[P_cols + S_cols].apply(pd.to_numeric, errors="coerce")
    df["P_mean"] = df[P_cols].mean(axis=1, skipna=True)
    df["S_mean"] = df[S_cols].mean(axis=1, skipna=True)

    return df[["cntry", "P_mean", "S_mean"]]


# =====================================================
# 3. å›å½’åˆ†æ
# =====================================================
def regression_analysis(df):
    df = df.copy()
    df["Î”P"] = df["P_mean"] - df["P_mean"].mean()
    df["Î”S"] = df["S_mean"] - df["S_mean"].mean()

    X = sm.add_constant(df["Î”S"])
    y = df["Î”P"]
    ols_model = sm.OLS(y, X).fit()

    rf = RandomForestRegressor(n_estimators=300, random_state=42)
    rf.fit(df[["Î”S"]], y)
    preds_rf = rf.predict(df[["Î”S"]])

    metrics = {
        "OLS_RÂ²": ols_model.rsquared,
        "OLS_MAE": mean_absolute_error(y, ols_model.predict(X)),
        "RF_RÂ²": r2_score(y, preds_rf),
        "RF_MAE": mean_absolute_error(y, preds_rf)
    }
    return metrics, ols_model, rf


# =====================================================
# 4. å¯è§†åŒ–å‡½æ•°
# =====================================================
def visualize(df, ols_model, outdir):
    df["Î”P"] = df["P_mean"] - df["P_mean"].mean()
    df["Î”S"] = df["S_mean"] - df["S_mean"].mean()

    plt.figure(figsize=(7, 5))
    plt.scatter(df["Î”S"], df["Î”P"], c="dodgerblue", alpha=0.6, label="å›½å®¶æ•°æ®")

    # OLS æ‹Ÿåˆçº¿
    x_pred = np.linspace(df["Î”S"].min(), df["Î”S"].max(), 100)
    y_ols = ols_model.params[0] + ols_model.params[1] * x_pred
    plt.plot(x_pred, y_ols, color="red", lw=2, label="OLS æ‹Ÿåˆ")

    # å¤šé¡¹å¼æ‹Ÿåˆï¼ˆ2é˜¶ï¼‰
    poly = PolynomialFeatures(degree=2)
    X_poly = poly.fit_transform(df[["Î”S"]])
    poly_model = LinearRegression().fit(X_poly, df["Î”P"])
    y_poly = poly_model.predict(poly.fit_transform(x_pred.reshape(-1, 1)))
    plt.plot(x_pred, y_poly, color="darkorange", lw=2, ls="--", label="äºŒé˜¶å¤šé¡¹å¼")

    # LOESSå¹³æ»‘
    loess_fit = lowess(df["Î”P"], df["Î”S"], frac=0.5)
    plt.plot(loess_fit[:, 0], loess_fit[:, 1], color="green", lw=2, label="LOESSå¹³æ»‘")

    plt.axhline(0, color="gray", lw=0.8, ls="--")
    plt.axvline(0, color="gray", lw=0.8, ls="--")
    plt.xlabel("Î”Sï¼ˆç¤¾ä¼šå˜åŒ–ï¼‰")
    plt.ylabel("Î”Pï¼ˆäººæ ¼å˜åŒ–ï¼‰")
    plt.title("Î”Pâ€“Î”S è€¦åˆå…³ç³»ï¼ˆå¤šæ¨¡å‹æ‹Ÿåˆï¼‰")
    plt.legend()
    plt.tight_layout()
    outpath = os.path.join(outdir, "Î”P_vs_Î”S_fits.png")
    plt.savefig(outpath, dpi=300)
    plt.close()
    logging.info(f"ğŸ“Š å·²ç”Ÿæˆæ‹Ÿåˆå›¾ï¼š{outpath}")


# =====================================================
# 5. é›·è¾¾å›¾ï¼šæ¯ä¸ªå›½å®¶äººæ ¼â€“ç¤¾ä¼šåˆ†å¸ƒ
# =====================================================
def plot_country_radar(df, outdir):
    from math import pi

    countries = df["cntry"].unique()
    num_countries = len(countries)
    radar_dir = os.path.join(outdir, "å›½å®¶é›·è¾¾å›¾")
    os.makedirs(radar_dir, exist_ok=True)

    for _, row in df.iterrows():
        values = [row["P_mean"], row["S_mean"]]
        categories = ["äººæ ¼(P)", "ç¤¾ä¼š(S)"]
        values += values[:1]
        N = len(categories)
        angles = [n / float(N) * 2 * np.pi for n in range(N)]
        angles += angles[:1]

        fig, ax = plt.subplots(subplot_kw={'polar': True})
        plt.xticks(angles[:-1], categories, color="grey", size=10)
        ax.plot(angles, values, linewidth=2, linestyle='solid')
        ax.fill(angles, values, alpha=0.25)
        plt.title(f"{row['cntry']} çš„ Pâ€“S å‡å€¼é›·è¾¾å›¾", size=12)
        out_path = os.path.join(radar_dir, f"{row['cntry']}_radar.png")
        plt.savefig(out_path, dpi=200)
        plt.close()
    logging.info(f"ğŸ“ˆ å·²ç”Ÿæˆ {num_countries} ä¸ªå›½å®¶é›·è¾¾å›¾è‡³ {radar_dir}")


# =====================================================
# 6. ä¸»å‡½æ•°
# =====================================================
def main():
    dfs = []
    for path in tqdm(ESS_PATHS, desc="è¯»å– ESS æ•°æ®"):
        df = load_ess(path)
        if df is not None:
            dfs.append(df)

    if not dfs:
        logging.error("âŒ æ— æ³•åŠ è½½ä»»ä½• ESS æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥è·¯å¾„ã€‚")
        return

    ess_all = pd.concat(dfs, ignore_index=True)
    ess_country = ess_all.groupby("cntry")[["P_mean", "S_mean"]].mean().reset_index()
    logging.info(f"âœ… å›½å®¶å±‚æ±‡æ€»å®Œæˆï¼Œå…± {len(ess_country)} ä¸ªå›½å®¶ã€‚")

    metrics, ols_model, rf_model = regression_analysis(ess_country)
    metrics_path = os.path.join(OUTDIR, "Î”P_Î”S_metrics.csv")
    pd.DataFrame([metrics]).to_csv(metrics_path, index=False)
    logging.info(f"ğŸ“ æ¨¡å‹æŒ‡æ ‡å·²ä¿å­˜è‡³: {metrics_path}")

    visualize(ess_country, ols_model, OUTDIR)
    plot_country_radar(ess_country, OUTDIR)
    logging.info("âœ… æ‰€æœ‰è®¡ç®—ä¸å›¾å½¢è¾“å‡ºå®Œæˆã€‚")


# =====================================================
if __name__ == "__main__":
    main()
